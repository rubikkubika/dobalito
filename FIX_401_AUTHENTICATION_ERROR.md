# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ 401 –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞ —á–µ—Ä–µ–∑ `/check-code` –ø–æ–ª—É—á–∞–ª–∏ –æ—à–∏–±–∫—É 401 "–ù–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –∏—Å—Ç–µ–∫—à–∏–π –∫–æ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏".

## üîç –ü—Ä–∏—á–∏–Ω–∞

–ú–µ—Ç–æ–¥ `PhoneVerificationService.verifyCode()` –ø–æ–º–µ—á–∞–µ—Ç –∫–æ–¥ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π (`setIsUsed(true)`), –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ —á–µ—Ä–µ–∑ `/verify-code` –∫–æ–¥ —É–∂–µ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω.

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏–π:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∫–æ–¥
2. Frontend –≤—ã–∑—ã–≤–∞–µ—Ç `/check-code` ‚Üí –∫–æ–¥ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π
3. Frontend –≤—ã–∑—ã–≤–∞–µ—Ç `/verify-code` ‚Üí –∫–æ–¥ —É–∂–µ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω ‚Üí –æ—à–∏–±–∫–∞ 401

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤ PhoneVerificationService

```java
/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –±–µ–∑ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏)
 */
public boolean checkCodeWithoutUsing(String phone, String code) {
    LocalDateTime now = LocalDateTime.now();
    Optional<PhoneVerificationCode> codeOptional = codeRepository.findByPhoneAndCode(phone, code, now);
    
    if (codeOptional.isEmpty()) {
        return false;
    }
    
    PhoneVerificationCode verificationCode = codeOptional.get();
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–æ–¥–∞ –±–µ–∑ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    return verificationCode.isValid();
}
```

### –û–±–Ω–æ–≤–ª–µ–Ω AuthController

**–ë—ã–ª–æ:**
```java
// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥
boolean isValidCode = phoneVerificationService.verifyCode(normalizedPhone, code);
```

**–°—Ç–∞–ª–æ:**
```java
// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ –±–µ–∑ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
boolean isValidCode = phoneVerificationService.checkCodeWithoutUsing(normalizedPhone, code);
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
```bash
# 1. –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞
curl -X POST http://localhost:8080/api/v1/auth/send-verification-code \
  -H "Content-Type: application/json" \
  -d '{"phone":"+79001234567"}'

# Response: {"code":"877327","success":true,...}

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ (–±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
curl -X POST http://localhost:8080/api/v1/auth/check-code \
  -H "Content-Type: application/json" \
  -d '{"phone":"+79001234567","code":"877327"}'

# Response: {"success":true,"isNewUser":false,...}

# 3. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–∫–æ–¥ –≤—Å–µ –µ—â–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω)
curl -X POST http://localhost:8080/api/v1/auth/verify-code \
  -H "Content-Type: application/json" \
  -d '{"phone":"+79001234567","code":"877327"}'

# Response: {"success":true,"user":{...}}
```

### –¢–µ—Å—Ç 2: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
```bash
# 1. –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞
curl -X POST http://localhost:8080/api/v1/auth/send-verification-code \
  -H "Content-Type: application/json" \
  -d '{"phone":"+79001234568"}'

# Response: {"code":"066027","success":true,...}

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ (–±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
curl -X POST http://localhost:8080/api/v1/auth/check-code \
  -H "Content-Type: application/json" \
  -d '{"phone":"+79001234568","code":"066027"}'

# Response: {"success":true,"isNewUser":true,...}

# 3. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å –∏–º–µ–Ω–µ–º (–∫–æ–¥ –≤—Å–µ –µ—â–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω)
curl -X POST http://localhost:8080/api/v1/auth/verify-code \
  -H "Content-Type: application/json" \
  -d '{"phone":"+79001234568","code":"066027","name":"Alex New"}'

# Response: {"success":true,"user":{"name":"Alex New",...}}
```

## üìã –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
1. **–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞** ‚Üí –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞** ‚Üí `checkCodeWithoutUsing()` ‚Üí –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º
3. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** ‚Üí `verifyCode()` ‚Üí –∫–æ–¥ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π ‚Üí —É—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

### –î–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
1. **–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞** ‚Üí –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞** ‚Üí `checkCodeWithoutUsing()` ‚Üí –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º ‚Üí `isNewUser: true`
3. **–í–≤–æ–¥ –∏–º–µ–Ω–∏** ‚Üí Frontend –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª–µ –∏–º–µ–Ω–∏
4. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** ‚Üí `verifyCode()` —Å –∏–º–µ–Ω–µ–º ‚Üí –∫–æ–¥ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí —É—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

- ‚úÖ **–ö–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã** –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ** —Ç–∏–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** –¥–ª—è –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –∫–æ–¥ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- ‚úÖ **UX** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –≤–≤–æ–¥–µ –∫–æ–¥–∞

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ú–µ—Ç–æ–¥—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞:

1. **`checkCodeWithoutUsing()`** - –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–æ–¥–∞
   - –ù–ï –ø–æ–º–µ—á–∞–µ—Ç –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `/check-code`

2. **`verifyCode()`** - –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–æ–¥–∞
   - –ü–æ–º–µ—á–∞–µ—Ç –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `/verify-code`

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- –ö–æ–¥ –≤—Å–µ —Ä–∞–≤–Ω–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω –∫–æ–¥ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã
